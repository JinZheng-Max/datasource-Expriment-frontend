<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¥–åŠ±å®¡æ ¸ - å­¦ç”Ÿä¿¡æ¯ç®¡ç†ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="../css/index.css">
    <link rel="stylesheet" href="../css/students.css">
    <script>
        if (!new URLSearchParams(location.search).has('standalone')) location.replace('reward.html');
    </script>
</head>

<body>
    <header class="top-header">
        <div class="header-left">
            <div class="logo">ğŸ“š</div>
            <h1>å­¦ç”Ÿä¿¡æ¯ç®¡ç†ç³»ç»Ÿ</h1>
        </div>
        <div class="header-right">
            <div class="user-info">
                <div class="user-avatar">
                    <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='50' fill='%23667eea'/%3E%3Ctext x='50' y='50' text-anchor='middle' dy='.3em' fill='white' font-size='40' font-family='Arial'%3Eç®¡%3C/text%3E%3C/svg%3E"
                        alt="ç”¨æˆ·å¤´åƒ">
                    <span class="username">ç³»ç»Ÿç®¡ç†å‘˜</span>
                </div>
            </div>
        </div>
    </header>

    <div class="main-container">
        <aside class="sidebar">
            <nav class="sidebar-nav">
                <div class="nav-item" onclick="location.href='index.html'"><span class="nav-icon">ğŸ“Š</span><span class="nav-text">æ•°æ®æ¦‚è§ˆ</span></div>
                <div class="nav-item" onclick="location.href='students.html'"><span class="nav-icon">ğŸ‘¨â€ğŸ“</span><span class="nav-text">å­¦ç”Ÿç®¡ç†</span></div>
                <div class="nav-item" onclick="location.href='status.html'"><span class="nav-icon">ğŸ“‹</span><span class="nav-text">å­¦ç±ç®¡ç†</span></div>
                <div class="nav-item" onclick="location.href='practice.html'"><span class="nav-icon">ğŸ†</span><span class="nav-text">ç¤¾ä¼šå®è·µ</span></div>
                <div class="nav-item" onclick="location.href='review-practice.html'"><span class="nav-icon">âœ…</span><span class="nav-text">å®è·µå®¡æ ¸</span></div>
                <div class="nav-item" onclick="location.href='reward.html'"><span class="nav-icon">ğŸ–ï¸</span><span class="nav-text">å¥–æƒ©ç®¡ç†</span></div>
                <div class="nav-item active"><span class="nav-icon">ğŸ“</span><span class="nav-text">å¥–åŠ±å®¡æ ¸</span></div>
                <div class="nav-item" onclick="location.href='scores.html'"><span class="nav-icon">ğŸ“</span><span class="nav-text">æˆç»©ç®¡ç†</span></div>
                <div class="nav-item" onclick="location.href='courses.html'"><span class="nav-icon">ğŸ“š</span><span class="nav-text">è¯¾ç¨‹ç®¡ç†</span></div>
            </nav>
            <div class="sidebar-footer">
                <div class="nav-item" id="logoutBtn"><span class="nav-icon">ğŸšª</span><span class="nav-text">é€€å‡ºç™»å½•</span></div>
            </div>
        </aside>

        <main class="main-content">
            <div class="page-header">
                <div>
                    <h2>ğŸ“ å¥–åŠ±å®¡æ ¸</h2>
                    <p class="subtitle">å®¡æ ¸å­¦ç”Ÿæäº¤çš„å¥–åŠ±ç”³è¯·</p>
                </div>
            </div>

            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>å­¦å·</th>
                            <th>å§“å</th>
                            <th>çº§åˆ«</th>
                            <th>å¥–åŠ±åç§°</th>
                            <th>è·å¥–æ—¥æœŸ</th>
                            <th>é¢å‘å•ä½</th>
                            <th>ç”³è¯·æ—¶é—´</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="pendingTableBody">
                        <tr><td colspan="8" class="empty-message">åŠ è½½ä¸­...</td></tr>
                    </tbody>
                </table>
            </div>

            <div class="pagination" id="pagination"></div>
        </main>
    </div>

    <!-- å®¡æ ¸å¼¹çª— -->
    <div class="modal-overlay" id="reviewModal" style="display:none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>å®¡æ ¸å¥–åŠ±ç”³è¯·</h3>
                <button class="modal-close" onclick="hideReviewModal()">&times;</button>
            </div>
            <div id="reviewInfo" class="review-info"></div>
            <form id="reviewForm">
                <input type="hidden" id="rpId" name="rpId">
                <div class="form-group">
                    <label>å®¡æ ¸ç»“æœ <span class="required">*</span></label>
                    <select id="status" name="status" required>
                        <option value="">è¯·é€‰æ‹©</option>
                        <option value="å·²é€šè¿‡">é€šè¿‡</option>
                        <option value="æœªé€šè¿‡">ä¸é€šè¿‡</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>å®¡æ ¸æ„è§</label>
                    <textarea id="reviewComment" name="reviewComment" rows="3" placeholder="å®¡æ ¸æ„è§ï¼ˆå¯é€‰ï¼‰"></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn-secondary" onclick="hideReviewModal()">å–æ¶ˆ</button>
                    <button type="submit" class="btn-primary">æäº¤å®¡æ ¸</button>
                </div>
            </form>
        </div>
    </div>

    <style>
        .table-container { background: white; border-radius: 16px; padding: 20px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08); overflow-x: auto; }
        .data-table { width: 100%; border-collapse: collapse; }
        .data-table th, .data-table td { padding: 12px 14px; text-align: left; border-bottom: 1px solid var(--border-color); }
        .data-table th { background: var(--bg-secondary); font-weight: 600; color: var(--text-secondary); font-size: 13px; }
        .data-table td { font-size: 14px; color: var(--text-primary); }
        .data-table tbody tr:hover { background: var(--bg-secondary); }
        .empty-message { text-align: center; color: var(--text-secondary); padding: 40px !important; }
        .btn-review { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 6px 16px; border-radius: 6px; cursor: pointer; font-size: 13px; }
        .btn-review:hover { transform: translateY(-1px); box-shadow: 0 2px 8px rgba(102, 126, 234, 0.4); }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 500; }
        .btn-secondary { background: #f5f5f5; color: #333; border: 1px solid #ddd; padding: 10px 20px; border-radius: 8px; cursor: pointer; }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .modal-content { background: white; border-radius: 16px; width: 500px; max-width: 90%; max-height: 90vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 20px; border-bottom: 1px solid #eee; }
        .modal-header h3 { margin: 0; font-size: 18px; }
        .modal-close { background: none; border: none; font-size: 24px; cursor: pointer; color: #999; }
        #reviewForm { padding: 20px; }
        .form-group { margin-bottom: 16px; }
        .form-group label { display: block; margin-bottom: 6px; font-size: 14px; color: #666; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; }
        .form-actions { display: flex; gap: 12px; justify-content: flex-end; margin-top: 20px; }
        .required { color: #f44336; }
        .review-info { padding: 15px 20px; background: #f9f9f9; margin: 0 20px; border-radius: 8px; }
        .review-info p { margin: 8px 0; font-size: 14px; }
        .review-info strong { color: #333; }
        .pagination { display: flex; justify-content: center; gap: 8px; margin-top: 20px; }
        .pagination button { padding: 8px 16px; border: 1px solid #ddd; background: white; border-radius: 6px; cursor: pointer; }
        .pagination button.active { background: #667eea; color: white; border-color: #667eea; }
        .pagination button:disabled { opacity: 0.5; cursor: not-allowed; }
    </style>

    <script src="../js/common.js"></script>
    <script>
        const API_BASE = 'http://localhost:8080/api';
        let currentPage = 1;
        let totalPages = 1;
        let currentRecord = null;

        document.addEventListener('DOMContentLoaded', function() {
            if (typeof initLogout === 'function') initLogout();
            loadPendingList();
            initReviewForm();
        });

        async function loadPendingList(page = 1) {
            currentPage = page;
            try {
                const res = await authFetch(`${API_BASE}/review/reward/pending?page=${page}&pageSize=10`);
                const data = await res.json();
                
                const tbody = document.getElementById('pendingTableBody');
                
                if (data.code === 1 && data.data) {
                    const result = data.data;
                    totalPages = Math.ceil(result.total / 10) || 1;
                    
                    if (result.records && result.records.length > 0) {
                        tbody.innerHTML = result.records.map(item => `
                            <tr>
                                <td>${item.studentNo || '-'}</td>
                                <td>${item.studentName || '-'}</td>
                                <td>${item.level || '-'}</td>
                                <td>${item.title || '-'}</td>
                                <td>${item.awardDate || '-'}</td>
                                <td>${item.issuingUnit || '-'}</td>
                                <td>${formatDateTime(item.applyTime)}</td>
                                <td><button class="btn-review" onclick='showReviewModal(${JSON.stringify(item)})'>å®¡æ ¸</button></td>
                            </tr>
                        `).join('');
                    } else {
                        tbody.innerHTML = '<tr><td colspan="8" class="empty-message">æš‚æ— å¾…å®¡æ ¸çš„ç”³è¯·</td></tr>';
                    }
                    renderPagination();
                } else {
                    tbody.innerHTML = '<tr><td colspan="8" class="empty-message">åŠ è½½å¤±è´¥</td></tr>';
                }
            } catch (err) {
                console.error('åŠ è½½å¾…å®¡æ ¸åˆ—è¡¨å¼‚å¸¸:', err);
                document.getElementById('pendingTableBody').innerHTML = '<tr><td colspan="8" class="empty-message">åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•</td></tr>';
            }
        }

        function formatDateTime(dt) {
            if (!dt) return '-';
            return dt.replace('T', ' ').substring(0, 16);
        }

        function renderPagination() {
            const container = document.getElementById('pagination');
            let html = '';
            html += `<button ${currentPage <= 1 ? 'disabled' : ''} onclick="loadPendingList(${currentPage - 1})">ä¸Šä¸€é¡µ</button>`;
            html += `<span style="padding: 8px 16px;">ç¬¬ ${currentPage} / ${totalPages} é¡µ</span>`;
            html += `<button ${currentPage >= totalPages ? 'disabled' : ''} onclick="loadPendingList(${currentPage + 1})">ä¸‹ä¸€é¡µ</button>`;
            container.innerHTML = html;
        }

        function showReviewModal(record) {
            currentRecord = record;
            document.getElementById('rpId').value = record.rpId;
            document.getElementById('reviewInfo').innerHTML = `
                <p><strong>å­¦ç”Ÿï¼š</strong>${record.studentNo} - ${record.studentName}</p>
                <p><strong>çº§åˆ«ï¼š</strong>${record.level} | <strong>å¥–åŠ±åç§°ï¼š</strong>${record.title}</p>
                <p><strong>è·å¥–æ—¥æœŸï¼š</strong>${record.awardDate || '-'} | <strong>é¢å‘å•ä½ï¼š</strong>${record.issuingUnit || '-'}</p>
                <p><strong>è·å¥–åŸå› ï¼š</strong>${record.reason || 'æ— '}</p>
                <p><strong>ç”³è¯·è¯´æ˜ï¼š</strong>${record.applyRemark || 'æ— '}</p>
            `;
            document.getElementById('reviewModal').style.display = 'flex';
        }

        function hideReviewModal() {
            document.getElementById('reviewModal').style.display = 'none';
            document.getElementById('reviewForm').reset();
            currentRecord = null;
        }

        function initReviewForm() {
            document.getElementById('reviewForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const status = document.getElementById('status').value;
                if (!status) {
                    showMessage('è¯·é€‰æ‹©å®¡æ ¸ç»“æœ', 'error');
                    return;
                }

                const dto = {
                    id: parseInt(document.getElementById('rpId').value),
                    status: status,
                    reviewComment: document.getElementById('reviewComment').value
                };

                try {
                    const res = await authFetch(`${API_BASE}/review/reward/review`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(dto)
                    });
                    const data = await res.json();
                    
                    if (data.code === 1) {
                        showMessage('å®¡æ ¸å®Œæˆ', 'success');
                        hideReviewModal();
                        loadPendingList(currentPage);
                    } else {
                        showMessage(data.msg || 'å®¡æ ¸å¤±è´¥', 'error');
                    }
                } catch (err) {
                    console.error('æäº¤å®¡æ ¸å¼‚å¸¸:', err);
                    showMessage('ç½‘ç»œå¼‚å¸¸ï¼Œè¯·ç¨åé‡è¯•', 'error');
                }
            });
        }
    </script>
</body>
</html>
